<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warframe Task Checklist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Global Theme Variables --- */
        :root {
            /* Default: Dark Mode */
            --bg-content: rgba(31, 41, 55, 0.95); /* gray-800 with opacity */
            --text-primary: #f3f4f6; /* gray-100 */
            --text-secondary: #9ca3af; /* gray-400 */
            --text-muted: #6b7280; /* gray-500 */
            --text-header: #ffffff; /* white */
            --text-label: #d1d5db; /* gray-300 */
            --text-label-checked: #9ca3af; /* gray-400 */
            --border-color: #4b5563; /* gray-600 */
            --checkbox-border: #6b7280; /* gray-500 */
            --checkbox-bg: rgba(255, 255, 255, 0.1);
            --checkbox-checked-bg: #4f46e5; /* indigo-600 */
            --checkbox-checked-border: #4f46e5;
            --link-color: #60a5fa; /* blue-400 */
            --link-hover-color: #93c5fd; /* blue-300 */
            --theme-toggle-border: #4b5563; /* gray-600 */
            --theme-toggle-hover-bg: rgba(255, 255, 255, 0.1);
            --theme-toggle-hover-border: #9ca3af; /* gray-400 */
            --theme-toggle-color: #9ca3af; /* gray-400 */
            --section-header-hover-bg: rgba(255, 255, 255, 0.05);
            --confirm-bg: #f59e0b; /* amber-500 */
            --confirm-hover-bg: #d97706; /* amber-600 */
            --confirm-text: #1f2937; /* gray-800 */
            --error-bg: #ef4444; /* red-500 */
            --error-border: #dc2626; /* red-600 */
            --error-text: #ffffff; /* white */
            --error-button-bg: rgba(255, 255, 255, 0.1);
            --error-button-hover-bg: rgba(255, 255, 255, 0.2);
            --menu-panel-bg: #272e3a; /* Slightly lighter than main dark bg for distinction */
            --menu-panel-border: #374151; /* gray-700 for dark mode menu border */
            --menu-title-color: #ffffff; /* White for dark menu title */
            --menu-close-btn-color: #9ca3af; /* gray-400 */
            --menu-close-btn-hover-color: #f3f4f6; /* gray-100 */
            --hide-section-btn-bg: var(--text-muted);
            --hide-section-btn-hover-bg: var(--text-secondary);
            --hide-section-btn-text: var(--text-primary);
        }

        body.light-mode { /* Variables for light mode applied to body */
            --bg-content: rgba(255, 255, 255, 0.95);
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --text-muted: #6b7280;
            --text-header: #111827;
            --text-label: #374151;
            --text-label-checked: #6b7280;
            --border-color: #e5e7eb;
            --checkbox-border: #cbd5e1;
            --checkbox-bg: rgba(0, 0, 0, 0.02);
            --link-color: #3b82f6;
            --link-hover-color: #2563eb;
            --theme-toggle-border: #d1d5db;
            --theme-toggle-hover-bg: rgba(0, 0, 0, 0.05);
            --theme-toggle-hover-border: #6b7280;
            --theme-toggle-color: #6b7280;
            --section-header-hover-bg: rgba(0, 0, 0, 0.03);
            --error-bg: #fee2e2;
            --error-border: #f87171;
            --error-text: #b91c1c;
            --error-button-bg: rgba(0, 0, 0, 0.05);
            --error-button-hover-bg: rgba(0, 0, 0, 0.1);
            /* Menu Specific Variables for Light Mode */
            --menu-panel-bg: #f9fafb; /* Solid gray-50 for light mode menu */
            --menu-panel-border: #e5e7eb; /* gray-200 for light mode menu border */
            --menu-title-color: #111827; /* Dark for light menu title */
            --menu-close-btn-color: #6b7280; /* gray-500 */
            --menu-close-btn-hover-color: #1f2937; /* gray-800 */
            --hide-section-btn-bg: var(--text-muted);
            --hide-section-btn-hover-bg: var(--text-secondary);
            --hide-section-btn-text: var(--text-primary);
        }

        /* --- Base Body Styles (Not affected by theme toggle) --- */
        body {
            font-family: 'Inter', sans-serif;
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
            background-color: #111827; /* Always dark gray-900 */
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6); /* Always dark overlay */
            z-index: -1;
        }

        /* --- Content Box Element Styling (Using Variables) --- */
        .checklist-content {
            background-color: var(--bg-content);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .checklist-content h1 { color: var(--text-header); }
        .checklist-content h2 {
             color: var(--text-header);
             cursor: pointer;
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 0.5rem 0.25rem;
             border-radius: 0.25rem;
             transition: background-color 0.15s ease-in-out;
        }
        .checklist-content h2:hover {
            background-color: var(--section-header-hover-bg);
        }
        .checklist-content h2 .reset-time-local {
            font-size: 0.75rem;
            font-weight: 400;
            color: var(--text-secondary);
            margin-left: 0.5rem;
        }

        .checklist-content label, .parent-task-header .task-text { color: var(--text-label); }
        .checklist-content #last-saved-timestamp,
        .checklist-content #storage-notice {
             color: var(--text-muted);
             font-size: 0.75rem;
             margin-top: 0.25rem;
        }
        .checklist-content .italic { color: var(--text-secondary); }
        .checklist-content .text-xs { color: var(--text-muted); }
        .checklist-content .border-b { border-color: var(--border-color); }
        .checklist-content .app-description {
            color: var(--text-secondary);
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .checklist-content .footer-links {
             font-size: 0.75rem;
             color: var(--text-muted);
        }
        .checklist-content .footer-links a {
             color: var(--link-color);
             text-decoration: underline;
             transition: color 0.2s ease;
             margin: 0 0.25rem;
        }
         .checklist-content .footer-links a:hover {
             color: var(--link-hover-color);
         }
         .checklist-content .footer-links span {
             color: var(--text-muted);
             margin: 0 0.1rem;
         }

        /* --- Collapsible Section Styles --- */
        .section-content, .subtask-list {
            overflow: hidden;
            max-height: 3000px;
            transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out 0.1s, visibility 0s linear 0s;
            opacity: 1;
            visibility: visible;
            padding-left: 0.5rem;
        }
        .section-content.collapsed, .subtask-list.collapsed {
            max-height: 0;
            opacity: 0;
            visibility: hidden;
            transition: max-height 0.4s ease-in-out, opacity 0.2s ease-in-out, visibility 0s linear 0.4s;
        }
        .collapse-icon {
            width: 1rem; height: 1rem;
            transition: transform 0.3s ease-in-out;
            flex-shrink: 0;
            margin-left: 0.5rem;
        }
        .section-toggle[aria-expanded="false"] .collapse-icon,
        .parent-task-header[aria-expanded="false"] .collapse-icon {
            transform: rotate(-90deg);
        }
        .subtask-list {
            margin-left: 1.5rem;
            padding-left: 0;
            list-style: none;
        }
        .parent-task-header {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .parent-task-header .task-text {
            flex-grow: 1;
            margin-left: 0.5rem;
        }
        .task-text.checked, label.checked {
            text-decoration: line-through;
            color: var(--text-label-checked);
        }
        .task-item.hidden-task {
            display: none !important;
        }
        .hide-task-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.125rem;
            margin-left: 0.5rem;
            opacity: 0.6;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .hide-task-btn svg {
            width: 1rem;
            height: 1rem;
        }
        .hide-task-btn:hover { opacity: 1; }
        .section-is-hidden-by-user {
            display: none !important;
        }
        .hide-section-button {
            background-color: var(--hide-section-btn-bg);
            color: var(--hide-section-btn-text);
            border: 1px solid var(--border-color);
            padding: 0.125rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 0.25rem;
            margin-left: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: none; /* Hidden by default */
        }
        .hide-section-button:hover {
            background-color: var(--hide-section-btn-hover-bg);
        }
        .hide-section-button.visible {
            display: inline-block;
        }


        /* --- Interactive Elements (Using Variables) --- */
        input[type="checkbox"] {
            appearance: none; -webkit-appearance: none; -moz-appearance: none;
            width: 1.25rem; height: 1.25rem;
            border: 2px solid var(--checkbox-border);
            border-radius: 0.25rem; cursor: pointer;
            position: relative; top: 0.2rem; margin-right: 0.5rem;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            background-color: var(--checkbox-bg);
            flex-shrink: 0;
        }
        input[type="checkbox"]:checked {
            background-color: var(--checkbox-checked-bg);
            border-color: var(--checkbox-checked-border);
        }
        input[type="checkbox"]:checked::after {
            content: '✔'; position: absolute;
            color: white; font-size: 0.8rem;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        li { margin-bottom: 0.5rem; }
        #save-status { transition: opacity 0.5s ease-in-out; }

        /* --- Buttons (Base styles, colors set below) --- */
        .menu-btn, #theme-toggle-button, #hamburger-button {
             font-weight: 600;
             padding: 0.5rem 1rem;
             border-radius: 0.375rem;
             transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
             border: 1px solid transparent;
             cursor: pointer;
             line-height: 1.5;
        }
        /* Specific Button Colors (Default State) */
        #reset-daily-button:not(.confirming) { background-color: #3b82f6; border-color: #3b82f6; color: white;}
        #reset-daily-button:not(.confirming):hover { background-color: #2563eb; border-color: #2563eb; color: white;}
        #reset-weekly-button:not(.confirming) { background-color: #14b8a6; border-color: #14b8a6; color: white;}
        #reset-weekly-button:not(.confirming):hover { background-color: #0d9488; border-color: #0d9488; color: white;}
        #reset-button:not(.confirming) { background-color: #ef4444; border-color: #ef4444; color: white;}
        #reset-button:not(.confirming):hover { background-color: #dc2626; border-color: #dc2626; color: white;}
        #unhide-tasks-button:not(.confirming) { background-color: #8b5cf6; border-color: #8b5cf6; color: white; }
        #unhide-tasks-button:not(.confirming):hover { background-color: #7c3aed; border-color: #7c3aed; color: white; }


        /* Confirmation State Styling (Applies to all reset buttons) */
        .menu-btn.confirming {
             background-color: var(--confirm-bg);
             border-color: var(--confirm-bg);
             color: var(--confirm-text) !important; /* Ensure dark text on amber */
        }
        .menu-btn.confirming:hover {
             background-color: var(--confirm-hover-bg);
             border-color: var(--confirm-hover-bg);
        }


        /* Theme Toggle Button Specifics (Using Variables) */
        #theme-toggle-button, #hamburger-button {
            background-color: transparent;
            border: 1px solid var(--theme-toggle-border);
            color: var(--theme-toggle-color);
            padding: 0.375rem;
            margin-top: 0; /* Reset margin from .menu-btn */
        }
        #theme-toggle-button { margin-right: 0.5rem; } /* Keep spacing between theme and hamburger */
        #hamburger-button { margin-right: 0; } /* Ensure hamburger is last */

        #theme-toggle-button:hover, #hamburger-button:hover {
            background-color: var(--theme-toggle-hover-bg);
            border-color: var(--theme-toggle-hover-border);
        }
        #theme-toggle-button svg, #hamburger-button svg {
            width: 1.25rem;
            height: 1.25rem;
            fill: currentColor;
        }
        body.light-mode #moon-icon { display: none; }
        body:not(.light-mode) #sun-icon { display: none; }

        /* --- Error Display --- */
        #error-display {
            background-color: var(--error-bg);
            color: var(--error-text);
            border: 1px solid var(--error-border);
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            display: none;
            align-items: center;
            gap: 0.75rem;
        }
        #error-display.visible { display: flex; }
        #error-message { flex-grow: 1; }
        #error-copy-button {
            background-color: var(--error-button-bg);
            color: var(--error-text);
            border: 1px solid transparent;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            flex-shrink: 0;
        }
        #error-copy-button:hover { background-color: var(--error-button-hover-bg); }
        #error-close-button {
            background: none; border: none;
            color: var(--error-text);
            font-size: 1.5rem; line-height: 1;
            cursor: pointer; padding: 0 0.5rem;
            opacity: 0.7; flex-shrink: 0;
        }
         #error-close-button:hover { opacity: 1; }

        /* --- Hamburger Menu (Modal Overlay Style) --- */
        #slideout-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.75);
            z-index: 999;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #slideout-menu-overlay.open {
            display: flex;
            opacity: 1;
        }
        #menu-content-box {
            background-color: var(--menu-panel-bg);
            border: 1px solid var(--menu-panel-border);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            padding: 1.5rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 300px;
            overflow-y: auto;
            max-height: 90vh;
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.2s ease-out 0.1s, opacity 0.2s ease-out 0.1s;
            position: relative;
        }
        #slideout-menu-overlay.open #menu-content-box {
            transform: scale(1);
            opacity: 1;
        }
        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--menu-panel-border);
        }
        .menu-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--menu-title-color);
        }
        #menu-close-button {
            background: none;
            border: none;
            font-size: 1.75rem;
            line-height: 1;
            color: var(--menu-close-btn-color);
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            opacity: 0.7;
        }
        #menu-close-button:hover {
            opacity: 1;
            color: var(--menu-close-btn-hover-color);
        }
        #slideout-menu-overlay .menu-btn {
            display: block;
            width: 100%;
            text-align: left;
            margin-top: 0;
            margin-right: 0;
            margin-bottom: 0.75rem;
        }
        #slideout-menu-overlay .menu-btn:last-child {
            margin-bottom: 0;
        }

    </style>
</head>
<body class="bg-gray-900">
    <div class="checklist-content max-w-3xl mx-auto my-4 md:my-8 p-6 md:p-8 rounded-lg shadow-xl relative">
        <div id="error-display">
            <span id="error-message"></span>
            <button id="error-copy-button">Copy</button>
            <button id="error-close-button" aria-label="Close error message">&times;</button>
        </div>

        <div class="flex flex-wrap justify-between items-center mb-4">
            <div class="mb-2 sm:mb-0"> <h1 class="text-2xl md:text-3xl font-bold">Warframe Task Checklist</h1>
                <p class="app-description text-base">Track your daily, weekly, and bi-weekly Warframe tasks.</p>
            </div>
            <div class="flex items-center space-x-2 mt-2 sm:mt-0"> <button id="theme-toggle-button" aria-label="Toggle theme">
                        <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                            <path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5h2.25a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.166 7.758a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z"/>
                        </svg>
                        <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                            <path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 003.463-.69.75.75 0 01.981.98 10.503 10.503 0 01-9.694 6.46c-5.799 0-10.5-4.7-10.5-10.5 0-3.51 1.713-6.637 4.43-8.565a.75.75 0 01.981.162z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                    <button id="hamburger-button" aria-label="Open menu">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                        </svg>
                    </button>
            </div>
        </div>
        <div id="checklist-container">
            <section id="daily-tasks-section" class="mb-8">
                <h2 class="text-xl font-semibold mb-1 border-b pb-2 text-indigo-700 section-toggle" aria-expanded="true" aria-controls="daily-tasks-content">
                    <span class="flex-grow">Daily Tasks <span class="reset-time-local" id="daily-reset-local-time">(Resets ...)</span></span>
                    <button class="hide-section-button" data-section-id="daily-tasks-section">Hide Section</button>
                    <svg class="collapse-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                    </svg>
                </h2>
                <div id="daily-tasks-content" class="section-content">
                    <ul class="list-none pl-0 mt-2"></ul>
                </div>
            </section>

            <section id="weekly-tasks-section" class="mb-8">
                <h2 class="text-xl font-semibold mb-1 border-b pb-2 text-teal-700 section-toggle" aria-expanded="true" aria-controls="weekly-tasks-content">
                    <span class="flex-grow">Weekly Tasks <span class="reset-time-local" id="weekly-reset-local-time">(Resets ...)</span></span>
                    <button class="hide-section-button" data-section-id="weekly-tasks-section">Hide Section</button>
                     <svg class="collapse-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                    </svg>
                </h2>
                <div id="weekly-tasks-content" class="section-content">
                    <ul class="list-none pl-0 mt-2"></ul>
                </div>
            </section>

            <section id="bi-weekly-tasks-section" class="mb-8">
                <h2 class="text-xl font-semibold mb-1 border-b pb-2 text-purple-700 section-toggle" aria-expanded="true" aria-controls="bi-weekly-tasks-content">
                    <span class="flex-grow">Bi-Weekly Task (Every 2 Weeks, Fri-Sun)</span>
                    <button class="hide-section-button" data-section-id="bi-weekly-tasks-section">Hide Section</button>
                     <svg class="collapse-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                    </svg>
                </h2>
                 <div id="bi-weekly-tasks-content" class="section-content">
                    <ul class="list-none pl-0 mt-2"></ul>
                 </div>
            </section>
        </div>

         <div class="mt-4 text-right"> <span id="save-status" class="text-sm text-green-600 opacity-0">Saved!</span>
             <p id="last-saved-timestamp" class="mt-1">Loading...</p>
             <p id="storage-notice" class="mt-1">Your progress is saved locally.</p>
        </div>

         <p class="text-sm italic mt-8">*Remember, you don't have to do everything! Prioritize tasks based on your current goals and progress.*</p>

         <div class="text-center mt-8 footer-links">
             <a href="https://github.com/warframe-tools/Task-Checklist" target="_blank" rel="noopener noreferrer">Github</a>
             <span>|</span>
             <a href="https://github.com/warframe-tools/Task-Checklist?tab=GPL-3.0-1-ov-file" target="_blank" rel="noopener noreferrer">License (GPLv3)</a>
             <span>|</span>
             <a href="https://hub.warframestat.us/" target="_blank" rel="noopener noreferrer">Warframe Hub</a>
             <span>|</span>
             <a href="https://warframe.fandom.com/" target="_blank" rel="noopener noreferrer">Warframe Wiki</a>
             <span>|</span>
             <a href="https://framehub.paroxity.net/" target="_blank" rel="noopener noreferrer">FrameHub</a>
         </div>

         <p class="text-xs text-center mt-4 version-text">App Version X</p>
         <p class="text-xs text-center mt-1 warframe-version-text">Warframe Version X</p>
         <p class="text-xs text-center mt-2 px-4 disclaimer-text">
             This is an unofficial fan-made tool. Warframe and all related assets are the intellectual property of Digital Extremes Ltd. This project is not affiliated with, endorsed by, or sponsored by Digital Extremes Ltd.
         </p>
    </div>

    <div id="slideout-menu-overlay">
        <div id="menu-content-box">
            <div class="menu-header">
                <span class="menu-title">Options</span>
                <button id="menu-close-button" aria-label="Close menu">&times;</button>
            </div>
            <button id="reset-daily-button" class="menu-btn">Reset Daily Checks</button>
            <button id="reset-weekly-button" class="menu-btn">Reset Weekly Checks</button>
            <button id="reset-button" class="menu-btn">Reset All Checks</button>
            <button id="unhide-tasks-button" class="menu-btn">Unhide All Tasks</button>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const backgroundImages = [
             'assets/garuda-fortuna.jpg',
             'assets/gara-eidolon.jpg',
             'assets/heart-of-deimos-warframe.jpg'
        ];
        const APP_VERSION = "1.1.0";
        const WARFRAME_VERSION = "38.5.11";
        const THEME_STORAGE_KEY = 'warframeChecklistTheme';

        function getStorageKey(appVersion) {
            const versionParts = appVersion.split('.');
            if (versionParts.length >= 1) {
                const major = versionParts[0];
                return `warframeChecklistData_v${major}`;
            }
            return `warframeChecklistData_v${appVersion.replace(/\./g, '_')}`;
        }
        const DATA_STORAGE_KEY = getStorageKey(APP_VERSION);


        // --- Task Data ---
        const tasks = {
            daily: [
                { id: 'daily_login', text: 'Log in: Collect the daily login reward.' },
                { id: 'daily_craft_forma', text: 'Crafting (Forma): Start building a new Forma (and collect finished ones).' },
                { id: 'daily_craft_other', text: 'Crafting (Other): Craft other daily resources/items using reusable blueprints (check Foundry/companion app).' },
                { id: 'daily_syndicate_gain', text: 'Syndicates (Orbiter): Gain daily standing cap with your pledged Syndicate(s).' },
                { id: 'daily_syndicate_spend', text: 'Syndicates (Orbiter - Spend): If maxed on standing, spend it (Relic packs, Vosfor packs, etc.).' },
                {
                    id: 'daily_world_syndicate_parent',
                    text: 'World Syndicates (Standing)',
                    isParent: true,
                    subtasks: [
                        { id: 'daily_world_syndicate_simaris', text: 'Cephalon Simaris (Relay)' },
                        { id: 'daily_world_syndicate_ostron', text: 'Ostron (Cetus)' },
                        { id: 'daily_world_syndicate_quills', text: 'The Quills (Cetus)' },
                        { id: 'daily_world_syndicate_solaris', text: 'Solaris United (Fortuna)' },
                        { id: 'daily_world_syndicate_vox', text: 'Vox Solaris (Fortuna)' },
                        { id: 'daily_world_syndicate_ventkids', text: 'Ventkids (Fortuna)' },
                        { id: 'daily_world_syndicate_entrati', text: 'Entrati (Necralisk)' },
                        { id: 'daily_world_syndicate_necraloid', text: 'Necraloid (Necralisk)' },
                        { id: 'daily_world_syndicate_holdfasts', text: 'The Holdfasts (Chrysalith)' },
                        { id: 'daily_world_syndicate_cavia', text: 'Cavia (Sanctum Anatomica)' },
                        { id: 'daily_world_syndicate_hex', text: 'The Hex (Höllvania Central Mall)' }
                    ]
                },
                { id: 'daily_dark_sector', text: 'Dark Sector Mission (Early Game): Complete one Dark Sector mission first for double credits (if needed & pre-Index).' },
                { id: 'daily_sortie', text: 'Sortie: Complete the 3 daily Sortie missions (requires The War Within).' },
                { id: 'daily_focus', text: 'Focus: Max out daily Focus gain (e.g., via Sanctuary Onslaught) (requires The Second Dream).' },
                { id: 'daily_steel_path', text: 'Steel Path Incursions: Complete daily Steel Path missions for Steel Essence (requires Steel Path unlocked).' }
            ],
            weekly: [
                { id: 'weekly_nightwave_complete', text: 'Nightwave: Complete relevant weekly Nightwave missions.' },
                { id: 'weekly_nightwave_spend', text: 'Nightwave (Spend): Spend Nightwave credits if needed (Aura mods, Catalysts/Reactors, etc.).' },
                { id: 'weekly_ayatan', text: 'Ayatan Treasure Hunt: Complete Maroo\'s weekly mission for an Ayatan Sculpture (Maroo\'s Bazaar)' },
                { id: 'weekly_clem', text: 'Help Clem: Help Clem with his weekly survival, or he will die. (Relay)' },
                { id: 'weekly_kahl_garrison', text: 'Weekly Break Narmer Mission: Complete Kahl\'s weekly mission for Stock (requires Veilbreaker).' },
                { id: 'weekly_iron_wake', text: 'Iron Wake (Paladino): Trade Riven Slivers with Paladino (requires The Chains of Harrow).' },
                { id: 'weekly_yonta', text: 'Archimedian Yonta (Zariman): Buy weekly Kuva with Voidplumes.' },
                { id: 'weekly_acridies', text: 'Acridies (Duviri/Dormizone): Check wares and spend Pathos Clamps if desired (Catalysts/Reactors recommended if needed).' },
                { id: 'weekly_archon_hunt', text: 'Archon Hunt: Complete the weekly Archon Hunt for a guaranteed Archon Shard (requires The New War).' },
                { id: 'weekly_duviri_circuit', text: 'Duviri Circuit (Normal): Check weekly Warframe options & run Circuit if desired (requires Duviri).' },
                { id: 'weekly_duviri_circuit_sp', text: 'Duviri Circuit (Steel Path): Check weekly Incarnon Adapters & run Circuit if desired (requires Steel Path & Duviri).' },
                { id: 'weekly_teshin', text: 'Teshin (Steel Path): Check Teshin\'s Steel Essence shop (especially for Umbra Forma rotation - approx. every 8 weeks).' },
                { id: 'weekly_bird3', text: 'Bird 3 (Cavia Syndicate): Buy the weekly Archon Shard for 30k Cavia Standing (requires Rank 5 Cavia).' },
                { id: 'weekly_netracells', text: 'Netracells (Tagfer): Complete up to 5 weekly Netracell missions for Archon Shard chances (requires Whispers in the Walls).' },
                { id: 'weekly_eda', text: 'Elite Deep Archimedea (Necraloid): Attempt weekly Elite Deep Archimedea for high Archon Shard chances (very endgame, requires Whispers in the Walls & Rank 5 Cavia).' },
                { id: 'weekly_eta', text: 'Elite Temporal Archimedea (Kaya): Attempt weekly Elite Temporal Archimedea for high Archon Shard chances (very endgame, requires Warframe 1999 & Rank 5 Hex).' },
                { id: 'weekly_calendar', text: 'Calendar (POM-2 Terminal): Complete weekly Calendar tasks (requires Warframe 1999).' }
            ],
            biWeekly: [
                { id: 'biweekly_baro', text: 'Baro Ki\'Teer: Check Baro Ki\'Teer\'s inventory on a Relay and purchase desired items with Ducats (trade Prime parts for Ducats).' }
            ]
        };

        // --- DOM Elements ---
        const bodyElement = document.body;
        const contentElement = document.querySelector('.checklist-content');
        const themeToggleButton = document.getElementById('theme-toggle-button');
        const hamburgerButton = document.getElementById('hamburger-button');
        const slideoutMenuOverlay = document.getElementById('slideout-menu-overlay');
        const menuContentBox = document.getElementById('menu-content-box');
        const menuCloseButton = document.getElementById('menu-close-button');
        const dailyList = document.querySelector('#daily-tasks-content ul');
        const weeklyList = document.querySelector('#weekly-tasks-content ul');
        const biWeeklyList = document.querySelector('#bi-weekly-tasks-content ul');
        const resetDailyButton = document.getElementById('reset-daily-button');
        const resetWeeklyButton = document.getElementById('reset-weekly-button');
        const resetButton = document.getElementById('reset-button');
        const unhideTasksButton = document.getElementById('unhide-tasks-button');
        const lastSavedTimestampElement = document.getElementById('last-saved-timestamp');
        const saveStatusElement = document.getElementById('save-status');
        const sectionToggles = document.querySelectorAll('.section-toggle');
        const dailyResetTimeElement = document.getElementById('daily-reset-local-time');
        const weeklyResetTimeElement = document.getElementById('weekly-reset-local-time');
        const errorDisplayElement = document.getElementById('error-display');
        const errorMessageElement = document.getElementById('error-message');
        const errorCloseButton = document.getElementById('error-close-button');
        const errorCopyButton = document.getElementById('error-copy-button');
        const appVersionElement = document.querySelector('.version-text');
        const wfVersionElement = document.querySelector('.warframe-version-text');
        let saveStatusTimeout;
        let countdownInterval;

        // --- State Variables ---
        const confirmState = {
            all: { timeout: null, isConfirming: false },
            daily: { timeout: null, isConfirming: false },
            weekly: { timeout: null, isConfirming: false },
            unhide: { timeout: null, isConfirming: false }
        };
        let checklistData = {
            progress: {},
            lastSaved: null,
            lastDailyReset: null,
            lastWeeklyReset: null,
            hiddenTasks: {},
            manuallyHiddenSections: {}
        };
        let currentTheme = 'dark';

        // --- Function Definitions ---

        function displayError(message) {
            if (!errorDisplayElement || !errorMessageElement) return;
            console.error("Displaying Error:", message);
            errorMessageElement.textContent = message;
            errorDisplayElement.classList.add('visible');
            if (errorCopyButton) errorCopyButton.textContent = 'Copy';
        }
        function hideError() {
             if (!errorDisplayElement) return;
             errorDisplayElement.classList.remove('visible');
             errorMessageElement.textContent = '';
             if (errorCopyButton) errorCopyButton.textContent = 'Copy';
        }
        function copyErrorToClipboard() {
            const errorMessage = errorMessageElement.textContent;
            if (!errorMessage || !navigator.clipboard) {
                console.warn("Clipboard API not available or no error message to copy.");
                if (errorCopyButton) errorCopyButton.textContent = 'Failed';
                setTimeout(() => { if (errorCopyButton) errorCopyButton.textContent = 'Copy'; }, 2000);
                return;
            }
            navigator.clipboard.writeText(errorMessage).then(() => {
                console.log("Error message copied to clipboard.");
                if (errorCopyButton) errorCopyButton.textContent = 'Copied!';
                setTimeout(() => { if (errorCopyButton) errorCopyButton.textContent = 'Copy'; }, 2000);
            }).catch(err => {
                console.error('Failed to copy error message: ', err);
                 if (errorCopyButton) errorCopyButton.textContent = 'Failed';
                 setTimeout(() => { if (errorCopyButton) errorCopyButton.textContent = 'Copy'; }, 2000);
            });
        }
        function applyTheme(theme) {
            if (!bodyElement) return;
            if (theme === 'light') {
                bodyElement.classList.add('light-mode');
            } else {
                bodyElement.classList.remove('light-mode');
            }
            currentTheme = theme;
            console.log(`Theme applied: ${theme}`);
        }
        function handleThemeToggle() {
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
            try { localStorage.setItem(THEME_STORAGE_KEY, newTheme); }
            catch (e) { console.error("Could not save theme preference:", e); }
        }
        function loadThemePreference() {
             let savedTheme = 'dark';
             try {
                 const storedTheme = localStorage.getItem(THEME_STORAGE_KEY);
                 if (storedTheme === 'light' || storedTheme === 'dark') { savedTheme = storedTheme; }
             } catch (e) {
                 console.error("Could not load theme preference:", e);
             }
             applyTheme(savedTheme);
        }
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'Never';
            try {
                const date = new Date(timestamp);
                if (isNaN(date.getTime())) return 'Invalid Date';
                return date.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
            } catch (e) { console.error("Error formatting timestamp:", e); return 'Error'; }
        }
        function updateLastSavedDisplay(timestamp) {
            if (lastSavedTimestampElement) {
                lastSavedTimestampElement.textContent = `Last saved: ${formatTimestamp(timestamp)}`;
            } else {
                 console.error("lastSavedTimestampElement not found");
            }
        }
        function showSaveStatus() {
            if (!saveStatusElement) return;
            clearTimeout(saveStatusTimeout);
            saveStatusElement.style.opacity = '1';
            saveStatusTimeout = setTimeout(() => { saveStatusElement.style.opacity = '0'; }, 1500);
        }
        function getMostRecentMondayMidnightUTC() {
            const now = new Date();
            const currentUTCDay = now.getUTCDay();
            const daysSinceMondayUTC = (currentUTCDay === 0) ? 6 : currentUTCDay - 1;
            const mondayUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
            mondayUTC.setUTCDate(mondayUTC.getUTCDate() - daysSinceMondayUTC);
            mondayUTC.setUTCHours(0, 0, 0, 0);
            return mondayUTC.getTime();
        }
         function getNextDailyMidnightUTC() {
             const now = new Date();
             const tomorrowUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() + 1));
             tomorrowUTC.setUTCHours(0, 0, 0, 0);
             return tomorrowUTC.getTime();
         }
        function getUTCDateString(dateObj) {
            const year = dateObj.getUTCFullYear();
            const month = (dateObj.getUTCMonth() + 1).toString().padStart(2, '0');
            const day = dateObj.getUTCDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        function getUTCDayOfYear(date) {
            const startOfYear = Date.UTC(date.getUTCFullYear(), 0, 0);
            const diff = date.getTime() - startOfYear;
            const oneDay = 1000 * 60 * 60 * 24;
            return Math.floor(diff / oneDay);
        }
        function setDailyBackground() {
            const now = new Date();
            const dayOfYear = getUTCDayOfYear(now);
            const imageIndex = dayOfYear % backgroundImages.length;
            const imageUrl = backgroundImages[imageIndex];
            console.log(`Setting background for UTC day ${dayOfYear}, index ${imageIndex}: ${imageUrl}`);
            if (bodyElement) {
                bodyElement.style.backgroundImage = `url('${imageUrl}')`;
            } else {
                 console.error("bodyElement not found");
            }
        }
        function formatCountdown(ms) {
            if (ms < 0) return "00:00:00";

            let totalSeconds = Math.floor(ms / 1000);
            let days = Math.floor(totalSeconds / (24 * 60 * 60));
            totalSeconds %= (24 * 60 * 60);
            let hours = Math.floor(totalSeconds / (60 * 60));
            totalSeconds %= (60 * 60);
            let minutes = Math.floor(totalSeconds / 60);
            let seconds = totalSeconds % 60;

            const pad = (num) => String(num).padStart(2, '0');

            if (days > 0) {
                return `${days}d ${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
            }
            return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
        }
         function displayLocalResetTimes() {
            try {
                const now = new Date().getTime();

                const nextDailyResetTimestamp = getNextDailyMidnightUTC();
                const dailyDiff = nextDailyResetTimestamp - now;
                if (dailyResetTimeElement) {
                    dailyResetTimeElement.textContent = `(Resets in ${formatCountdown(dailyDiff)})`;
                } else { console.warn("Daily reset time element not found."); }

                let nextWeeklyResetTimestamp = getMostRecentMondayMidnightUTC();
                 if (now >= nextWeeklyResetTimestamp) {
                     nextWeeklyResetTimestamp += 7 * 24 * 60 * 60 * 1000;
                 }
                const weeklyDiff = nextWeeklyResetTimestamp - now;
                 if (weeklyResetTimeElement) {
                    weeklyResetTimeElement.textContent = `(Resets in ${formatCountdown(weeklyDiff)})`;
                } else { console.warn("Weekly reset time element not found."); }
            } catch (e) {
                console.error("Error calculating or displaying local reset times:", e);
                 if (dailyResetTimeElement) dailyResetTimeElement.textContent = `(Resets 00:00 UTC)`;
                 if (weeklyResetTimeElement) weeklyResetTimeElement.textContent = `(Resets Mon 00:00 UTC)`;
            }
        }
        function runAutoResets() {
            const now = new Date();
            const nowUTCTimestamp = now.getTime();
            const todayUTCString = getUTCDateString(now);
            let didReset = false;

            const lastDailyResetDate = checklistData.lastDailyReset ? new Date(checklistData.lastDailyReset) : null;
            let lastDailyResetUTCString = lastDailyResetDate ? getUTCDateString(lastDailyResetDate) : null;
            if (!lastDailyResetUTCString || lastDailyResetUTCString !== todayUTCString) {
                console.log(`Performing daily auto-reset (UTC). Today: ${todayUTCString}, Last Reset: ${lastDailyResetUTCString}`);
                tasks.daily.forEach(task => {
                    if (checklistData.progress[task.id] && !checklistData.hiddenTasks[task.id]) {
                        checklistData.progress[task.id] = false;
                        didReset = true;
                    }
                    if (task.isParent && task.subtasks) {
                        task.subtasks.forEach(subtask => {
                            if (checklistData.progress[subtask.id] && !checklistData.hiddenTasks[subtask.id]) {
                                checklistData.progress[subtask.id] = false;
                            }
                        });
                    }
                });
                checklistData.lastDailyReset = now.toISOString();
            }

            const lastWeeklyResetTimestamp = checklistData.lastWeeklyReset ? new Date(checklistData.lastWeeklyReset).getTime() : null;
            const mostRecentMondayUTCTimestamp = getMostRecentMondayMidnightUTC();
            if (!lastWeeklyResetTimestamp || lastWeeklyResetTimestamp < mostRecentMondayUTCTimestamp) {
                 if (nowUTCTimestamp >= mostRecentMondayUTCTimestamp) {
                    console.log(`Performing weekly auto-reset (UTC). Current Time: ${nowUTCTimestamp}, Last Reset: ${lastWeeklyResetTimestamp}, Target Monday: ${mostRecentMondayUTCTimestamp}`);
                    tasks.weekly.forEach(task => {
                        if (checklistData.progress[task.id] && !checklistData.hiddenTasks[task.id]) {
                            checklistData.progress[task.id] = false;
                            didReset = true;
                        }
                    });
                    checklistData.lastWeeklyReset = now.toISOString();
                 }
            }
            return didReset;
        }
        function saveData(showStatus = true) {
            hideError();
            checklistData.lastSaved = new Date().toISOString();
            try {
                localStorage.setItem(DATA_STORAGE_KEY, JSON.stringify(checklistData));
                updateLastSavedDisplay(checklistData.lastSaved);
                if (showStatus) { showSaveStatus(); }
            } catch (e) {
                console.error("Error saving data to localStorage:", e);
                let userMessage = "Could not save progress.";
                if (e.name === 'QuotaExceededError' || (e.code && (e.code === 22 || e.code === 1014))) {
                     userMessage = "Could not save progress. Browser storage might be full.";
                }
                displayError(userMessage);
            }
        }
        function createChecklistItem(task, isChecked, isSubtask = false) {
            const listItem = document.createElement('li');
            listItem.classList.add('task-item');
            if (checklistData.hiddenTasks[task.id]) {
                listItem.classList.add('hidden-task');
            }

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = task.id;
            checkbox.checked = isChecked;
            checkbox.classList.add('mt-1');
            if (isSubtask) {
                checkbox.dataset.parentId = task.parentId;
            }

            const hideButton = document.createElement('button');
            hideButton.classList.add('hide-task-btn');
            hideButton.setAttribute('aria-label', `Hide task: ${task.text}`);
            hideButton.title = `Hide task: ${task.text}`;
            hideButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.522 10.522 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>`;

            hideButton.addEventListener('click', (e) => {
                e.stopPropagation();
                checklistData.hiddenTasks[task.id] = true;
                listItem.classList.add('hidden-task');
                updateSectionControls(listItem.closest('section').id);
                saveData(false);
            });

            if (task.isParent) {
                listItem.classList.add('parent-task-container', 'flex', 'flex-col');

                const parentHeaderDiv = document.createElement('div');
                parentHeaderDiv.classList.add('parent-task-header', 'flex', 'items-center', 'mb-1', 'w-full');
                parentHeaderDiv.setAttribute('aria-expanded', 'true');
                parentHeaderDiv.setAttribute('aria-controls', `${task.id}-subtasks`);

                parentHeaderDiv.appendChild(checkbox);

                const taskTextSpan = document.createElement('span');
                taskTextSpan.textContent = task.text;
                taskTextSpan.classList.add('task-text', 'ml-2', 'flex-grow', 'cursor-pointer');
                if (isChecked) taskTextSpan.classList.add('checked');

                const collapseIcon = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                collapseIcon.setAttribute('class', 'collapse-icon');
                collapseIcon.setAttribute('fill', 'none');
                collapseIcon.setAttribute('viewBox', '0 0 24 24');
                collapseIcon.setAttribute('stroke-width', '1.5');
                collapseIcon.setAttribute('stroke', 'currentColor');
                collapseIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />';

                parentHeaderDiv.appendChild(taskTextSpan);
                parentHeaderDiv.appendChild(collapseIcon);
                parentHeaderDiv.appendChild(hideButton);
                listItem.appendChild(parentHeaderDiv);

                const subtaskList = document.createElement('ul');
                subtaskList.id = `${task.id}-subtasks`;
                subtaskList.classList.add('list-none', 'pl-0', 'mt-1', 'subtask-list');
                if (task.subtasks && Array.isArray(task.subtasks)) {
                    task.subtasks.forEach(subtask => {
                        subtask.parentId = task.id;
                        const subtaskIsChecked = checklistData.progress[subtask.id] || false;
                        const subtaskItem = createChecklistItem(subtask, subtaskIsChecked, true);
                        subtaskList.appendChild(subtaskItem);
                    });
                }
                listItem.appendChild(subtaskList);

                parentHeaderDiv.addEventListener('click', (e) => {
                    if (e.target !== checkbox && !checkbox.contains(e.target) && e.target !== hideButton && !hideButton.contains(e.target) && !collapseIcon.contains(e.target)) {
                        const isExpanded = parentHeaderDiv.getAttribute('aria-expanded') === 'true';
                        parentHeaderDiv.setAttribute('aria-expanded', !isExpanded);
                        subtaskList.classList.toggle('collapsed', isExpanded);
                    }
                });
                 collapseIcon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isExpanded = parentHeaderDiv.getAttribute('aria-expanded') === 'true';
                    parentHeaderDiv.setAttribute('aria-expanded', !isExpanded);
                    subtaskList.classList.toggle('collapsed', isExpanded);
                });

                 checkbox.addEventListener('change', (event) => {
                    const currentlyChecked = event.target.checked;
                    checklistData.progress[task.id] = currentlyChecked;
                    taskTextSpan.classList.toggle('checked', currentlyChecked);

                    task.subtasks.forEach(subtask => {
                        checklistData.progress[subtask.id] = currentlyChecked;
                        const subCheckbox = document.getElementById(subtask.id);
                        const subLabel = document.querySelector(`label[for="${subtask.id}"]`);
                        if (subCheckbox) subCheckbox.checked = currentlyChecked;
                        if (subLabel) subLabel.classList.toggle('checked', currentlyChecked);
                    });
                    saveData();
                });

            } else {
                listItem.classList.add('flex', 'items-center', 'mb-2');
                 if (isSubtask) {
                    listItem.classList.add('ml-4');
                }

                const label = document.createElement('label');
                label.htmlFor = task.id;
                label.textContent = task.text;
                label.classList.add('ml-2', 'flex-1', 'cursor-pointer');
                if (isChecked) { label.classList.add('checked'); }

                listItem.appendChild(checkbox);
                listItem.appendChild(label);
                listItem.appendChild(hideButton);

                checkbox.addEventListener('change', (event) => {
                    const currentlyChecked = event.target.checked;
                    checklistData.progress[task.id] = currentlyChecked;
                    label.classList.toggle('checked', currentlyChecked);

                    if (isSubtask && task.parentId) {
                        const parentTaskDefinition = tasks.daily.find(t => t.id === task.parentId);
                        if (parentTaskDefinition && parentTaskDefinition.subtasks) {
                            const allSubtasksChecked = parentTaskDefinition.subtasks.every(st => checklistData.progress[st.id]);
                            checklistData.progress[parentTaskDefinition.id] = allSubtasksChecked;
                            const parentCheckbox = document.getElementById(parentTaskDefinition.id);
                            const parentContainer = parentCheckbox ? parentCheckbox.closest('.parent-task-container') : null;
                            const parentTextSpan = parentContainer ? parentContainer.querySelector('.parent-task-header .task-text') : null;

                            if (parentCheckbox) parentCheckbox.checked = allSubtasksChecked;
                            if (parentTextSpan) parentTextSpan.classList.toggle('checked', allSubtasksChecked);
                        }
                    }
                    saveData();
                });

                label.addEventListener('click', () => {
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                });
            }
            return listItem;
        }
        function populateSection(sectionElement, taskList, progress) {
            if (!sectionElement) {
                console.error("Section element not found for population:", sectionElement);
                return;
            }
            sectionElement.innerHTML = '';
            taskList.forEach(task => {
                const isChecked = progress[task.id] || false;
                const listItem = createChecklistItem(task, isChecked);
                sectionElement.appendChild(listItem);
            });
            if (sectionElement.parentElement && sectionElement.parentElement.id) {
                 updateSectionControls(sectionElement.parentElement.id);
            }
        }
        function resetSpecificButtonState(buttonElement, defaultText, stateKey) {
            if (!buttonElement || !confirmState[stateKey]) return;
            clearTimeout(confirmState[stateKey].timeout);
            confirmState[stateKey].timeout = null;
            confirmState[stateKey].isConfirming = false;
            buttonElement.textContent = defaultText;
            buttonElement.classList.remove('confirming');
            console.log(`Button ${buttonElement.id} state reverted.`);
        }
        function handleResetConfirmation(buttonElement, confirmKey, defaultText, resetAction) {
            if (!confirmState[confirmKey]) {
                console.error("Invalid confirmKey:", confirmKey);
                return;
            }

             if (!confirmState[confirmKey].isConfirming) {
                 Object.keys(confirmState).forEach(key => {
                     if (key !== confirmKey && confirmState[key].isConfirming) {
                         let btnElement, btnText;
                         if (key === 'all') { btnElement = resetButton; btnText = 'Reset All Checks'; }
                         else if (key === 'daily') { btnElement = resetDailyButton; btnText = 'Reset Daily Checks'; }
                         else if (key === 'weekly') { btnElement = resetWeeklyButton; btnText = 'Reset Weekly Checks'; }
                         else if (key === 'unhide') { btnElement = unhideTasksButton; btnText = 'Unhide All Tasks'; }
                         if(btnElement) {
                            resetSpecificButtonState(btnElement, btnText, key);
                         }
                     }
                 });
             }

            if (confirmState[confirmKey].isConfirming) {
                 console.log(`${defaultText} confirmed by second click.`);
                 resetAction();
                 resetSpecificButtonState(buttonElement, defaultText, confirmKey);
            } else {
                confirmState[confirmKey].isConfirming = true;
                buttonElement.textContent = 'Are you Sure?';
                buttonElement.classList.add('confirming');
                clearTimeout(confirmState[confirmKey].timeout);

                confirmState[confirmKey].timeout = setTimeout(() => {
                    if (confirmState[confirmKey].isConfirming) {
                        resetSpecificButtonState(buttonElement, defaultText, confirmKey);
                    }
                }, 10000);
            }
        }
        function resetAllAction() {
            checklistData.progress = {};
            localStorage.setItem(DATA_STORAGE_KEY, JSON.stringify(checklistData));

            const allCheckboxes = document.querySelectorAll('#checklist-container input[type="checkbox"]');
            allCheckboxes.forEach((checkbox) => {
                checkbox.checked = false;
                const listItem = checkbox.closest('li');
                const label = listItem.querySelector('label');
                const parentTextSpan = listItem.querySelector('.parent-task-header .task-text');
                if (label) label.classList.remove('checked');
                if (parentTextSpan) parentTextSpan.classList.remove('checked');
            });
            updateLastSavedDisplay(checklistData.lastSaved);
            console.log("Checklist reset complete.");
        }
        function resetDailyAction() {
            tasks.daily.forEach(task => {
                checklistData.progress[task.id] = false;
                const checkbox = document.getElementById(task.id);
                if (checkbox) {
                    checkbox.checked = false;
                    const listItem = checkbox.closest('li');
                    const label = listItem.querySelector('label');
                    const parentTextSpan = listItem.querySelector('.parent-task-header .task-text');
                    if (label) label.classList.remove('checked');
                    if (parentTextSpan) parentTextSpan.classList.remove('checked');
                }
                if (task.isParent && task.subtasks) {
                    task.subtasks.forEach(subtask => {
                        checklistData.progress[subtask.id] = false;
                        const subCheckbox = document.getElementById(subtask.id);
                        if (subCheckbox) {
                            subCheckbox.checked = false;
                            const subLabel = subCheckbox.closest('li').querySelector('label');
                            if (subLabel) subLabel.classList.remove('checked');
                        }
                    });
                }
            });
            checklistData.lastDailyReset = new Date().toISOString();
            saveData();
            console.log("Daily checks manually reset.");
        }
        function resetWeeklyAction() {
            tasks.weekly.forEach(task => {
                checklistData.progress[task.id] = false;
                const checkbox = document.getElementById(task.id);
                if (checkbox) {
                    checkbox.checked = false;
                    const label = checkbox.closest('li').querySelector('label');
                    if (label) label.classList.remove('checked');
                }
            });
            checklistData.lastWeeklyReset = new Date().toISOString();
            saveData();
            console.log("Weekly checks manually reset.");
        }
        function handleSectionToggle(event) {
            const header = event.target.closest('.section-toggle');
            if (!header) return;
            const contentId = header.getAttribute('aria-controls');
            const contentDiv = document.getElementById(contentId);
            if (!contentDiv) return;
            const isExpanded = header.getAttribute('aria-expanded') === 'true';
            header.setAttribute('aria-expanded', !isExpanded);
            contentDiv.classList.toggle('collapsed', isExpanded);
            console.log(`Toggled section ${contentId} to ${!isExpanded ? 'expanded' : 'collapsed'}`);
        }
        function toggleMenu() {
            if (slideoutMenuOverlay) {
                slideoutMenuOverlay.classList.toggle('open');
            }
        }
        function unhideAllAction() {
            checklistData.hiddenTasks = {};
            checklistData.manuallyHiddenSections = {};
            saveData(false);

            document.querySelectorAll('.task-item.hidden-task').forEach(item => item.classList.remove('hidden-task'));
            document.querySelectorAll('section.section-is-hidden-by-user').forEach(section => section.classList.remove('section-is-hidden-by-user'));

            populateSection(dailyList, tasks.daily, checklistData.progress);
            populateSection(weeklyList, tasks.weekly, checklistData.progress);
            populateSection(biWeeklyList, tasks.biWeekly, checklistData.progress);
            ['daily-tasks-section', 'weekly-tasks-section', 'bi-weekly-tasks-section'].forEach(updateSectionControls);
            console.log("All tasks and sections unhidden.");
            toggleMenu();
        }

        function updateSectionControls(sectionElementId) {
            const sectionElement = document.getElementById(sectionElementId);
            if (!sectionElement) return;

            const hideSectionButton = sectionElement.querySelector('.hide-section-button');
            if (!hideSectionButton) return;

            if (checklistData.manuallyHiddenSections[sectionElementId]) {
                sectionElement.classList.add('section-is-hidden-by-user');
                hideSectionButton.classList.remove('visible');
                return;
            } else {
                sectionElement.classList.remove('section-is-hidden-by-user');
            }

            const contentUl = sectionElement.querySelector('.section-content ul');
            if (!contentUl) {
                hideSectionButton.classList.remove('visible');
                return;
            }

            const allTaskItems = Array.from(contentUl.querySelectorAll('li.task-item'));
            if (allTaskItems.length === 0) {
                hideSectionButton.classList.remove('visible');
                return;
            }

            const allTasksIndividuallyHidden = allTaskItems.every(item => item.classList.contains('hidden-task'));

            if (allTasksIndividuallyHidden) {
                hideSectionButton.classList.add('visible');
            } else {
                hideSectionButton.classList.remove('visible');
            }
        }


        function loadAndInitialize() {
            hideError();
            loadThemePreference();

            const savedData = localStorage.getItem(DATA_STORAGE_KEY);
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    if (parsedData && typeof parsedData === 'object') {
                        checklistData.progress = parsedData.progress || {};
                        checklistData.lastSaved = parsedData.lastSaved || null;
                        checklistData.lastDailyReset = parsedData.lastDailyReset || null;
                        checklistData.lastWeeklyReset = parsedData.lastWeeklyReset || null;
                        checklistData.hiddenTasks = parsedData.hiddenTasks || {};
                        checklistData.manuallyHiddenSections = parsedData.manuallyHiddenSections || {};
                    } else { console.warn("Invalid data format found in localStorage. Starting fresh."); }
                } catch (e) {
                    console.error("Error parsing saved data:", e);
                    displayError("Failed to load saved progress. Data might be corrupted.");
                    checklistData = { progress: {}, lastSaved: null, lastDailyReset: null, lastWeeklyReset: null, hiddenTasks: {}, manuallyHiddenSections: {} };
                }
            }

            setDailyBackground();
            displayLocalResetTimes();
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(displayLocalResetTimes, 1000);

            const needsSaveAfterReset = runAutoResets();
            if (needsSaveAfterReset) {
                console.log("Saving data after auto-reset.");
                saveData(false);
            }

            populateSection(dailyList, tasks.daily, checklistData.progress);
            populateSection(weeklyList, tasks.weekly, checklistData.progress);
            populateSection(biWeeklyList, tasks.biWeekly, checklistData.progress);
            updateLastSavedDisplay(checklistData.lastSaved);

             ['daily-tasks-section', 'weekly-tasks-section', 'bi-weekly-tasks-section'].forEach(updateSectionControls);
        }

        // --- Initialization ---
        try {
             if(appVersionElement) appVersionElement.textContent = `App Version ${APP_VERSION}`;
             else console.error("App version element not found!");

             if(wfVersionElement) wfVersionElement.textContent = `Warframe Version ${WARFRAME_VERSION}`;
             else console.error("Warframe version element not found!");

            loadAndInitialize();

            if (resetDailyButton) { resetDailyButton.addEventListener('click', () => handleResetConfirmation(resetDailyButton, 'daily', 'Reset Daily Checks', resetDailyAction)); }
            else { console.error("Reset Daily button element not found!"); }

            if (resetWeeklyButton) { resetWeeklyButton.addEventListener('click', () => handleResetConfirmation(resetWeeklyButton, 'weekly', 'Reset Weekly Checks', resetWeeklyAction)); }
            else { console.error("Reset Weekly button element not found!"); }

            if (resetButton) { resetButton.addEventListener('click', () => handleResetConfirmation(resetButton, 'all', 'Reset All Checks', resetAllAction)); }
            else { console.error("Reset All button element not found!"); }

            if (unhideTasksButton) { unhideTasksButton.addEventListener('click', () => handleResetConfirmation(unhideTasksButton, 'unhide', 'Unhide All Tasks', unhideAllAction)); }
            else { console.error("Unhide Tasks button not found!");}

            if (themeToggleButton) { themeToggleButton.addEventListener('click', handleThemeToggle); }
            else { console.error("Theme toggle button not found!"); }

            if (hamburgerButton) { hamburgerButton.addEventListener('click', toggleMenu); }
            else { console.error("Hamburger button not found!"); }

            if (slideoutMenuOverlay) {
                slideoutMenuOverlay.addEventListener('click', function(event) {
                    if (event.target === slideoutMenuOverlay) {
                        toggleMenu();
                    }
                });
            } else { console.error("Slideout menu overlay not found!"); }

            if (menuCloseButton) {
                menuCloseButton.addEventListener('click', toggleMenu);
            } else { console.error("Menu close button not found!"); }


            sectionToggles.forEach(toggle => {
                toggle.addEventListener('click', handleSectionToggle);
            });

            document.getElementById('checklist-container').addEventListener('click', function(event) {
                if (event.target.classList.contains('hide-section-button')) {
                    const sectionId = event.target.dataset.sectionId;
                    if (sectionId) {
                        const sectionElement = document.getElementById(sectionId);
                        if (sectionElement) {
                            checklistData.manuallyHiddenSections[sectionId] = true;
                            sectionElement.classList.add('section-is-hidden-by-user');
                            event.target.classList.remove('visible');
                            saveData(false);
                            console.log(`Section ${sectionId} manually hidden.`);
                        }
                    }
                }
            });


            if (errorCloseButton) {
                 errorCloseButton.addEventListener('click', hideError);
            } else { console.error("Error close button not found!"); }

             if (errorCopyButton) {
                 errorCopyButton.addEventListener('click', copyErrorToClipboard);
             } else { console.error("Error copy button not found!"); }

            console.log(`Warframe Checklist App Initialized (v${APP_VERSION}).`);

        } catch(error) {
             console.error("Critical Error during initialization:", error);
             const errDisp = document.getElementById('error-display');
             const errMsg = document.getElementById('error-message');
             if(errDisp && errMsg) {
                errMsg.textContent = "A critical error occurred during startup. Please check the console.";
                errDisp.classList.add('visible');
             } else {
                alert("A critical error occurred during startup. Please check the console.");
             }
        }
    </script>
</body>
</html>
